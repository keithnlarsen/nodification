<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <script type='text/javascript' language="javascript" src='/javascript/jquery-1.7.1.min.js'></script>
    <script type='text/javascript' language="javascript" src='/javascript/jquery.tmpl.js'></script>
    <script type='text/javascript' language="javascript" src='/javascript/knockout-1.2.1.js'></script>
    <script type='text/javascript' language="javascript" src='/javascript/knockout.mapping-oct18.js'></script>
    <link type="text/css" rel="stylesheet" href="/stylesheets/style.css">

    <title>Nodifications</title>
  </head>
  <body>


    <div id="top-bar">

      <div class="container">
        <a class="title" href="/">Nodifications</a>
        <ul class="nav">
          <li class="selected"><a href="/notificationTypes">Types</a></li>
          <li><a href="/registrations">Registrations</a></li>
        </ul>
      </div>
    </div>
    <div id="main-container" class="container">

      <div id="content-container">
        <div class="sub-title">
          <h3>Notification Types
            <a class="button secondary" href="javascript:void(0);" data-bind="click: showNew">+ new
            notification type</a>
          </h3>

          <div id="feedbackMessage"><span></span></div>
        </div>

        <div id="content">
          <div id="details-container">
            <div class="details-title">
              <span data-bind="text:currentType.name"></span>
              <a class="button secondary" href="javascript:void(0);" alt="delete notification type"
                 title="delete notification type" data-bind="click: removeCurrent"> delete</a>
            </div>
            <table class="details">
              <tr>
                <td class="label">Name:</td>
                <td><input type="text" data-bind="value:currentType.name"/></td>
              </tr>
              <tr>
                <td class="label">Registration URL:</td>
                <td><input type="text" data-bind="value:currentType.registrationUrl"/></td>
              </tr>
              <tr>
                <td class="label">Username:</td>
                <td><input type="text" data-bind="value:currentType.userName"/></td>
              </tr>
              <tr>
                <td class="label">Password:</td>
                <td><input type="password" data-bind="value:currentType.password"/></td>
              </tr>
              <tr>
                <td colspan="2" class="label">
                  <a class="button primary" href="javascript:void(0);" data-bind="click: save">Save</a>
                  <a class="button secondary" href="javascript:void(0);" data-bind="click: cancel">Cancel</a>
                </td>
              </tr>
            </table>
          </div>
          <!--			  <ul class="labels">
               <li>Name:</li>
               <li>Registration URL:</li>
               <li>Username:</li>
               <li>Password:</li>
               </ul>
               <ul class="details">
               <li><input type="text" data-bind="value:notificationType.name || ''"/></li>
               <li><input type="text" data-bind="value:notificationType.registrationUrl || ''"/></li>
               <li><input type="text" data-bind="value:notificationType.userName || ''"/></li>
               <li><input type="password" data-bind="value:notificationType.userName || ''"/></li>
               </ul>-->

          <div id="list-container">
            <table class="list">
              <thead>
              <th>Name</th>
              <th>Registration URL</th>
              <th>Username</th>
              <th class="button-column"></th>
              <th class="button-column"></th>
              </thead>
              <tbody data-bind="template: { name:'notificationTypeTableTemplate', foreach: notificationTypes }"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>


    <script id="notificationTypeTableTemplate" type="text/html">
      <tr>
        <td>${ name }</td>
        <td>${ registrationUrl }</td>
        <td>${ userName }</td>
        <td><a class="button primary" href="javascript:void(0);" data-bind="click: show">Edit</a></td>
        <td><a class="button secondary" href="javascript:void(0);" data-bind="click: remove">Delete</a></td>
      </tr>
    </script>

    <script type='text/javascript'>
            
      var parent = this;
      this.viewModel;


      function notificationType ( data ) {
        this._id = ko.observable( data._id );
        this.name = ko.observable( data.name || "New Notification Type" );
        this.registrationUrl = ko.observable( data.registrationUrl || '' );
        this.userName = ko.observable( data.userName || data.username || '' );

        this.show = function () {
          parent.viewModel.currentType = this;
          ko.applyBindings(parent.viewModel);
          $( '#details-container' ).show( 400 );
        };

        this.remove = function () {
          var self = this;
          _delete( ko.mapping.toJS( this )._id, function () {
            parent.viewModel.notificationTypes.remove( self );
          });
        };
      }

      function notificationTypesViewModel () {
        this.notificationTypes = ko.observableArray( [] );
        this.currentType = new notificationType( {} );

        this.showNew = function() {
          parent.viewModel.currentType = new notificationType( {} );
          ko.applyBindings(parent.viewModel);
          $( '#details-container' ).show( 400 );
        };

        this.save = function() {
          var self = parent.viewModel.currentType;
          var notificationType = ko.mapping.toJS( self );
          var id = notificationType._id;
          
          delete notificationType['_id'];
          delete notificationType['show'];
          delete notificationType['remove'];

          if( typeof id == 'undefined'){
            _create( notificationType, function () {
              parent.viewModel.notificationTypes.push(self);
              $( '#details-container' ).hide( 400 );
            });
          } else {
            _update( id, notificationType, function () {
              $( '#details-container' ).hide( 400 );
            });
          }
        };

        this.removeCurrent = function () {
          var self = parent.viewModel.currentType;
          var notificationType = ko.mapping.toJS( self );
          if( typeof notificationType._id != 'undefined' ) {
            _delete( notificationType._id, function () {
              parent.viewModel.notificationTypes.remove( self );
              $( '#details-container' ).hide( 400 );
            });
          } else {
            this.cancel();
          }
        };
        
        this.cancel = function () {
          $( '#details-container' ).hide( 400 );
        };
        
        var self = this;
        _bindData( <%- JSON.stringify(notificationTypes) %> );
        _listNotificationTypes(self);
      }

      this.viewModel = new notificationTypesViewModel();
      ko.applyBindings(this.viewModel);


      function _bindData( data ){
        var mappedTypes = $.map ( data, function( item ) {
          return new notificationType( item );
        });

        self.notificationTypes( mappedTypes );
      }
      
      function _listNotificationTypes (self) {
        $.ajax( {
          type: 'GET',
          url: '/notificationTypes',
          contentType: 'application/json; charset=utf-8',
          success: function ( data ) {
            _bindData( data );
          },
          error: function () {
            _displayMessage( "An error occurred while retrieving the Notification Types.", true );
          }
        } );
      }


      function _create ( notificationType, callback ) {
        $.ajax( {
          type: 'PUT',
          url: '/notificationTypes',
          data: notificationType,
          success: function ( notificationTypeMod ) {
            callback();
            _displayMessage( "Notification Type has been saved." );
          },
          error: function () {
            _displayMessage( "Notification Type could not be saved.", true );
          }
        } );
      }
      
      function _update ( notificationTypeId, notificationType, callback ) {
        $.ajax( {
          type: 'POST',
          url: '/notificationTypes/' + notificationTypeId,
          data: notificationType,
          success: function ( data ) {
            callback();
            _displayMessage( "Notification Type has been saved." );
          },
          error: function () {
            _displayMessage( "Notification Type could not be saved.", true );
          }
        } );
      }

      function _delete ( notificationTypeId, callback ) {
        $.ajax( {
          type: 'DELETE',
          url: '/notificationTypes/' + notificationTypeId,
          success: function ( data ) {
            callback();
            _displayMessage( "Notification Type has been deleted." );
          },
          error: function () {
            _displayMessage( "Notification Type could not be deleted.", true );
          }
        } );
      }
      
      function _displayMessage ( msg, error ) {
        $( '#feedbackMessage span' ).html( msg );
        if ( error ) {
          $( '#feedbackMessage' ).addClass( 'error' ).show( 'slow' );
        } else {
          $( '#feedbackMessage' ).removeClass( 'error' ).show( 'slow' );
        }
        setTimeout( function() {
          $( '#feedbackMessage' ).hide( 'slow' );
        }, 10000 );
      }

    </script>

  </body>
</html>